{% extends 'base.html' %}

{% block title %}Investment Thesis Analysis - Intelligence System{% endblock %}

{% block content %}
<div class="container">
    <!-- Main Analysis Interface -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-1">
                <i class="fas fa-brain text-primary"></i>
                Investment Thesis Analysis
            </h1>
            <p class="text-muted">Input your thesis statement, attach research documents, and extract actionable signals</p>
        </div>
    </div>

    <form id="analysis-form" method="POST" enctype="multipart/form-data">
        <div class="row">
            <!-- Thesis Input -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-quote-left"></i> Investment Thesis Statement
                        </h5>
                    </div>
                    <div class="card-body">
                        <textarea name="thesis_text" class="form-control" rows="8" 
                                  placeholder="Enter your investment thesis statement here. Describe your core investment logic, expected outcomes, and key assumptions..."
                                  required></textarea>
                        <div class="form-text">
                            Provide a detailed thesis statement including your investment logic, key assumptions, and expected market dynamics.
                        </div>
                    </div>
                </div>

                <!-- Research Documents -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-paperclip"></i> Supporting Research Documents
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="upload-area" class="upload-area border rounded p-4 text-center">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-3"></i>
                            <h6>Drag & Drop Research Files</h6>
                            <p class="text-muted mb-3">PDF reports, Excel models, CSV data files</p>
                            <input type="file" id="research-files" name="research_files" multiple 
                                   accept=".pdf,.xlsx,.xls,.csv" class="d-none">
                            <button type="button" class="btn btn-outline-primary" 
                                    onclick="document.getElementById('research-files').click()">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                        
                        <div id="file-list" class="mt-3" style="display: none;">
                            <h6>Selected Files:</h6>
                            <div id="selected-files"></div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="focus-primary-signals" name="focus_primary_signals" checked>
                                    <label class="form-check-label" for="focus-primary-signals">
                                        <strong>Focus on Primary (Level 0-1) Signals</strong>
                                        <small class="d-block text-muted">Prioritize raw economic activity indicators</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-analytics"></i> Analyze Thesis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signal Classification Guide -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-signal"></i> Signal Classification
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-success me-2">Level 0</span>
                                <strong class="small">Raw Economic Activity</strong>
                            </div>
                            <small class="text-muted">
                                Direct measurements: housing starts, permit applications, factory utilization
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-info me-2">Level 1</span>
                                <strong class="small">Simple Aggregation</strong>
                            </div>
                            <small class="text-muted">
                                Basic combinations: monthly spending totals, inventory levels
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-warning me-2">Level 2</span>
                                <strong class="small">Derived Metrics</strong>
                            </div>
                            <small class="text-muted">
                                Calculated ratios: growth rates, market share changes
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2">Level 3+</span>
                                <strong class="small">Complex Derivatives</strong>
                            </div>
                            <small class="text-muted">
                                Processed indicators: credit scores, synthetic metrics
                            </small>
                        </div>

                        <hr>
                        
                        <div class="alert alert-info small">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Focus Strategy:</strong> Prioritize Level 0-1 signals for early market detection and unique insights.
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-search"></i> What We Extract
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="small mb-0">
                            <li>Primary signal identification</li>
                            <li>Signal classification (Level 0-4)</li>
                            <li>Lead/lag relationships</li>
                            <li>Value chain mapping</li>
                            <li>Early warning indicators</li>
                            <li>Market pricing gaps</li>
                            <li>Correlation patterns</li>
                            <li>Signal quality assessment</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Analysis Results (Hidden until analysis is complete) -->
    <div id="analysis-results" style="display: none;" class="mt-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i> Signal Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="results-content">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="loading-spinner mb-3"></div>
                <h5>Analyzing Investment Thesis</h5>
                <p class="text-muted mb-0">Extracting signals and mapping relationships...</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('research-files');
    const fileList = document.getElementById('file-list');
    const selectedFiles = document.getElementById('selected-files');
    const analysisForm = document.getElementById('analysis-form');

    // File upload handling
    fileInput.addEventListener('change', function() {
        displaySelectedFiles();
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-primary');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
        fileInput.files = e.dataTransfer.files;
        displaySelectedFiles();
    });

    function displaySelectedFiles() {
        const files = fileInput.files;
        if (files.length > 0) {
            fileList.style.display = 'block';
            selectedFiles.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'small text-muted mb-1';
                fileDiv.innerHTML = `
                    <i class="fas fa-file me-2"></i>
                    ${file.name} (${formatFileSize(file.size)})
                `;
                selectedFiles.appendChild(fileDiv);
            }
        } else {
            fileList.style.display = 'none';
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission
    analysisForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading modal
        const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
        modal.show();
        
        // Simulate progress
        const progressBar = document.querySelector('.progress-bar');
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 500);

        // Submit form
        const formData = new FormData(analysisForm);
        
        fetch('/analyze', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(interval);
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                modal.hide();
                displayResults(data);
            }, 1000);
        })
        .catch(error => {
            clearInterval(interval);
            modal.hide();
            console.error('Error:', error);
            alert('Analysis failed. Please try again.');
        });
    });

    function displayResults(data) {
        const resultsDiv = document.getElementById('analysis-results');
        const contentDiv = document.getElementById('results-content');
        
        // Populate results
        contentDiv.innerHTML = generateResultsHTML(data);
        resultsDiv.style.display = 'block';
        
        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function generateResultsHTML(data) {
        const signalData = data.signal_extraction || {};
        const thesisData = data.thesis_analysis || {};
        
        return `
            <div class="row">
                <!-- Signal Overview -->
                <div class="col-12 mb-4">
                    <div class="alert alert-success">
                        <h5 class="alert-heading">Analysis Complete</h5>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <strong>${signalData.total_signals_identified || 0}</strong>
                                <div class="small">Total Signals</div>
                            </div>
                            <div class="col-md-3">
                                <strong>${signalData.primary_signals_count || 0}</strong>
                                <div class="small">Primary Signals</div>
                            </div>
                            <div class="col-md-3">
                                <strong>${data.processed_documents || 0}</strong>
                                <div class="small">Documents Processed</div>
                            </div>
                            <div class="col-md-3">
                                <strong>${signalData.quality_assessment?.assessment || 'N/A'}</strong>
                                <div class="small">Signal Quality</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Core Thesis Analysis -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-bullseye"></i> Core Investment Logic</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Core Claim:</strong>
                                <p class="small">${thesisData.core_claim || 'Analysis in progress...'}</p>
                            </div>
                            <div class="mb-3">
                                <strong>Mental Model:</strong>
                                <span class="badge bg-primary">${thesisData.mental_model || 'Unknown'}</span>
                            </div>
                            ${generateAssumptionsList(thesisData.assumptions)}
                            ${generateCausalChain(thesisData.causal_chain)}
                        </div>
                    </div>
                </div>
                
                <!-- Counter-Thesis Scenarios -->
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Counter-Thesis Scenarios</h6>
                        </div>
                        <div class="card-body">
                            ${generateCounterThesisScenarios(thesisData.counter_thesis_scenarios)}
                        </div>
                    </div>
                </div>
                
                <!-- Signal Classification -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-signal"></i> Signal Classification</h6>
                        </div>
                        <div class="card-body">
                            ${generateSignalsByLevel(signalData.signals_by_level)}
                        </div>
                    </div>
                </div>
                
                <!-- Value Chain Mapping -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-sitemap"></i> Value Chain Signal Mapping</h6>
                        </div>
                        <div class="card-body">
                            ${generateValueChainMapping(signalData.value_chain_mapping)}
                        </div>
                    </div>
                </div>
                
                <!-- Monitoring Recommendations -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-eye"></i> Monitoring Strategy</h6>
                        </div>
                        <div class="card-body">
                            ${generateMonitoringStrategy(signalData.recommended_monitoring)}
                        </div>
                    </div>
                </div>
                
                <!-- Primary Signals Detail -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list"></i> Primary Signals Detail</h6>
                        </div>
                        <div class="card-body">
                            ${generatePrimarySignalsTable(signalData.raw_signals)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function generateAssumptionsList(assumptions) {
        if (!assumptions || !Array.isArray(assumptions)) return '';
        
        return `
            <div>
                <strong>Key Assumptions:</strong>
                <ul class="small mt-2">
                    ${assumptions.slice(0, 3).map(assumption => `<li>${assumption}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    function generateCausalChain(causalChain) {
        if (!causalChain || !Array.isArray(causalChain)) return '';
        
        return `
            <div class="mb-3">
                <strong class="small">Causal Chain:</strong>
                <ol class="small mt-1">
                    ${causalChain.slice(0, 5).map(step => `<li>${step}</li>`).join('')}
                </ol>
            </div>
        `;
    }
    
    function generateCounterThesisScenarios(scenarios) {
        if (!scenarios || !Array.isArray(scenarios)) return '<p class="text-muted">No counter-thesis scenarios identified</p>';
        
        return scenarios.slice(0, 4).map((scenario, index) => `
            <div class="border rounded p-3 mb-3">
                <h6 class="text-danger">${scenario.scenario || `Scenario ${index + 1}`}</h6>
                <p class="small mb-2">${scenario.description || 'No description available'}</p>
                ${scenario.trigger_conditions ? `
                    <div class="mb-2">
                        <strong class="small">Trigger Conditions:</strong>
                        <ul class="small mb-0">
                            ${scenario.trigger_conditions.slice(0, 3).map(condition => `<li>${condition}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${scenario.data_signals ? `
                    <div>
                        <strong class="small">Data Signals:</strong>
                        <ul class="small mb-0">
                            ${scenario.data_signals.slice(0, 3).map(signal => `<li>${signal}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    function generateSignalsByLevel(signalsByLevel) {
        if (!signalsByLevel) return '<p class="text-muted">No signals classified</p>';
        
        const levelBadges = {
            'Raw Economic Activity': 'bg-success',
            'Simple Aggregation': 'bg-info',
            'Derived Metrics': 'bg-warning',
            'Complex Derivatives': 'bg-secondary',
            'Synthetic Indicators': 'bg-dark'
        };
        
        return Object.entries(signalsByLevel).map(([level, signals]) => `
            <div class="mb-2">
                <span class="badge ${levelBadges[level] || 'bg-secondary'}">${signals.length}</span>
                <small class="ms-2">${level}</small>
            </div>
        `).join('');
    }
    
    function generateValueChainMapping(valueChain) {
        if (!valueChain) return '<p class="text-muted">No value chain mapping available</p>';
        
        // Calculate signal counts from the actual signal data
        const upstream = valueChain.upstream || [];
        const midstream = valueChain.midstream || [];
        const downstream = valueChain.downstream || [];
        
        return `
            <div class="row text-center">
                <div class="col-4">
                    <div class="border rounded p-2 bg-secondary">
                        <strong class="small text-light">Upstream</strong>
                        <div class="small text-light">${upstream.length} signals</div>
                        ${upstream.length > 0 ? `
                            <div class="mt-1">
                                ${upstream.slice(0, 2).map(signal => `<div class="badge bg-success text-dark me-1 mb-1">${signal.name || signal}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="col-4">
                    <div class="border rounded p-2 bg-secondary">
                        <strong class="small text-light">Midstream</strong>
                        <div class="small text-light">${midstream.length} signals</div>
                        ${midstream.length > 0 ? `
                            <div class="mt-1">
                                ${midstream.slice(0, 2).map(signal => `<div class="badge bg-info text-dark me-1 mb-1">${signal.name || signal}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="col-4">
                    <div class="border rounded p-2 bg-secondary">
                        <strong class="small text-light">Downstream</strong>
                        <div class="small text-light">${downstream.length} signals</div>
                        ${downstream.length > 0 ? `
                            <div class="mt-1">
                                ${downstream.slice(0, 2).map(signal => `<div class="badge bg-warning text-dark me-1 mb-1">${signal.name || signal}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    function generateMonitoringStrategy(strategy) {
        if (!strategy) return '<p class="text-muted">No monitoring recommendations</p>';
        
        return `
            <div class="mb-3">
                <strong class="small">Priority Signals:</strong>
                <ul class="small mt-1">
                    ${(strategy.priority_signals || []).slice(0, 3).map(signal => `<li>${signal}</li>`).join('')}
                </ul>
            </div>
            <div class="mb-3">
                <strong class="small">Frequency:</strong>
                <span class="badge bg-info">${strategy.monitoring_frequency || 'Unknown'}</span>
            </div>
            <div>
                <strong class="small">Automation Opportunities:</strong>
                <div class="small text-muted">${(strategy.automation_opportunities || []).length} signals</div>
            </div>
        `;
    }
    
    function generatePrimarySignalsTable(rawSignals) {
        if (!rawSignals || !Array.isArray(rawSignals)) return '<p class="text-muted">No signals identified</p>';
        
        const primarySignals = rawSignals.filter(signal => 
            signal.level === 'Raw Economic Activity' || signal.level === 'Simple Aggregation'
        );
        
        if (primarySignals.length === 0) return '<p class="text-muted">No primary signals identified</p>';
        
        return `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Signal</th>
                            <th>Level</th>
                            <th>Value Chain</th>
                            <th>Predictive Power</th>
                            <th>Reliability</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${primarySignals.slice(0, 10).map(signal => `
                            <tr>
                                <td><strong>${signal.name}</strong></td>
                                <td><span class="badge ${signal.level === 'Raw Economic Activity' ? 'bg-success' : 'bg-info'}">${signal.level.replace(' ', '<br>')}</span></td>
                                <td class="small">${signal.value_chain_position}</td>
                                <td><span class="badge ${getPredictiveBadge(signal.predictive_power)}">${signal.predictive_power}</span></td>
                                <td>${(signal.reliability_score * 100).toFixed(0)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    function getPredictiveBadge(power) {
        switch(power) {
            case 'high': return 'bg-success';
            case 'medium': return 'bg-warning';
            case 'low': return 'bg-secondary';
            default: return 'bg-light';
        }
    }
});
</script>
{% endblock %}