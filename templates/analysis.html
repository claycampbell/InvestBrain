{% extends 'base.html' %}

{% block title %}Investment Thesis Analysis - Intelligence System{% endblock %}

{% block content %}
<div class="container">
    <!-- Main Analysis Interface -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-1">
                <i class="fas fa-brain text-primary"></i>
                Investment Thesis Analysis
            </h1>
            <p class="text-muted">Input your thesis statement, attach research documents, and extract actionable signals</p>
        </div>
    </div>

    <form id="analysis-form" method="POST" enctype="multipart/form-data">
        <div class="row">
            <!-- Thesis Input -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-quote-left"></i> Investment Thesis Statement
                        </h5>
                    </div>
                    <div class="card-body">
                        <textarea name="thesis_text" class="form-control" rows="8" 
                                  placeholder="Enter your investment thesis statement here. Describe your core investment logic, expected outcomes, and key assumptions..."
                                  required></textarea>
                        <div class="form-text">
                            Provide a detailed thesis statement including your investment logic, key assumptions, and expected market dynamics.
                        </div>
                    </div>
                </div>

                <!-- Research Documents -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-paperclip"></i> Supporting Research Documents
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="upload-area" class="upload-area border rounded p-4 text-center">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-3"></i>
                            <h6>Drag & Drop Research Files</h6>
                            <p class="text-muted mb-3">PDF reports, Excel models, CSV data files</p>
                            <input type="file" id="research-files" name="research_files" multiple 
                                   accept=".pdf,.xlsx,.xls,.csv" class="d-none">
                            <button type="button" class="btn btn-outline-primary" 
                                    onclick="document.getElementById('research-files').click()">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                        
                        <div id="file-list" class="mt-3" style="display: none;">
                            <h6>Selected Files:</h6>
                            <div id="selected-files"></div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="focus-primary-signals" name="focus_primary_signals" checked>
                                    <label class="form-check-label" for="focus-primary-signals">
                                        <strong>Focus on Primary (Level 0-1) Signals</strong>
                                        <small class="d-block text-muted">Prioritize raw economic activity indicators</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-analytics"></i> Analyze Thesis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signal Classification Guide -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-signal"></i> Signal Classification
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-success me-2">Level 0</span>
                                <strong class="small">Raw Economic Activity</strong>
                            </div>
                            <small class="text-muted">
                                Direct measurements: housing starts, permit applications, factory utilization
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-info me-2">Level 1</span>
                                <strong class="small">Simple Aggregation</strong>
                            </div>
                            <small class="text-muted">
                                Basic combinations: monthly spending totals, inventory levels
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-warning me-2">Level 2</span>
                                <strong class="small">Derived Metrics</strong>
                            </div>
                            <small class="text-muted">
                                Calculated ratios: growth rates, market share changes
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2">Level 3+</span>
                                <strong class="small">Complex Derivatives</strong>
                            </div>
                            <small class="text-muted">
                                Processed indicators: credit scores, synthetic metrics
                            </small>
                        </div>

                        <hr>
                        
                        <div class="alert alert-info small">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Focus Strategy:</strong> Prioritize Level 0-1 signals for early market detection and unique insights.
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-search"></i> What We Extract
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="small mb-0">
                            <li>Primary signal identification</li>
                            <li>Signal classification (Level 0-4)</li>
                            <li>Lead/lag relationships</li>
                            <li>Value chain mapping</li>
                            <li>Early warning indicators</li>
                            <li>Market pricing gaps</li>
                            <li>Correlation patterns</li>
                            <li>Signal quality assessment</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Analysis Results (Hidden until analysis is complete) -->
    <div id="analysis-results" style="display: none;" class="mt-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i> Signal Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="results-content">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="loading-spinner mb-3"></div>
                <h5>Analyzing Investment Thesis</h5>
                <p class="text-muted mb-0">Extracting signals and mapping relationships...</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('research-files');
    const fileList = document.getElementById('file-list');
    const selectedFiles = document.getElementById('selected-files');
    const analysisForm = document.getElementById('analysis-form');

    // File upload handling
    fileInput.addEventListener('change', function() {
        displaySelectedFiles();
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-primary');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
        fileInput.files = e.dataTransfer.files;
        displaySelectedFiles();
    });

    function displaySelectedFiles() {
        const files = fileInput.files;
        if (files.length > 0) {
            fileList.style.display = 'block';
            selectedFiles.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'small text-muted mb-1';
                fileDiv.innerHTML = `
                    <i class="fas fa-file me-2"></i>
                    ${file.name} (${formatFileSize(file.size)})
                `;
                selectedFiles.appendChild(fileDiv);
            }
        } else {
            fileList.style.display = 'none';
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission
    analysisForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading modal
        const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
        modal.show();
        
        // Simulate progress
        const progressBar = document.querySelector('.progress-bar');
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 500);

        // Submit form
        const formData = new FormData(analysisForm);
        
        fetch('/analyze', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(interval);
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                modal.hide();
                displayResults(data);
            }, 1000);
        })
        .catch(error => {
            clearInterval(interval);
            modal.hide();
            console.error('Error:', error);
            alert('Analysis failed. Please try again.');
        });
    });

    function displayResults(data) {
        const resultsDiv = document.getElementById('analysis-results');
        const contentDiv = document.getElementById('results-content');
        
        // Populate results
        contentDiv.innerHTML = generateResultsHTML(data);
        resultsDiv.style.display = 'block';
        
        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function generateResultsHTML(data) {
        // This will be populated with actual analysis results
        return `
            <div class="row">
                <div class="col-md-6">
                    <h6>Primary Signals Identified</h6>
                    <div class="small text-muted">Results will be displayed here after analysis</div>
                </div>
                <div class="col-md-6">
                    <h6>Signal Classification</h6>
                    <div class="small text-muted">Signal hierarchy and relationships</div>
                </div>
            </div>
        `;
    }
});
</script>
{% endblock %}