<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Test</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
    <div id="simulationTest">
        <h3>Testing Simulation Display</h3>
        <button onclick="testSimulation()">Test Simulation</button>
        <div id="results"></div>
        <div id="chart"></div>
    </div>

    <script>
        async function testSimulation() {
            try {
                const response = await fetch('/api/thesis/58/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        time_horizon: 1,
                        scenario: 'base',
                        volatility: 'moderate',
                        include_events: false
                    })
                });

                const data = await response.json();
                
                document.getElementById('results').innerHTML = `
                    <h4>Simulation Results</h4>
                    <p><strong>Status:</strong> ${data.error ? 'Error' : 'Success'}</p>
                    <p><strong>Performance Points:</strong> ${data.performance_data?.performance?.length || 0}</p>
                    <p><strong>Benchmark Points:</strong> ${data.performance_data?.benchmark?.length || 0}</p>
                    <p><strong>Timeline Length:</strong> ${data.performance_data?.timeline?.length || 0}</p>
                    <p><strong>Events:</strong> ${data.events?.length || 0}</p>
                    <p><strong>Title:</strong> ${data.simulation_metadata?.title || 'Missing'}</p>
                    <p><strong>Data Source:</strong> ${data.simulation_metadata?.data_source || 'Unknown'}</p>
                `;

                // Test chart rendering
                if (data.performance_data?.performance) {
                    renderChart(data);
                }

            } catch (error) {
                document.getElementById('results').innerHTML = `
                    <h4>Error</h4>
                    <p style="color: red;">${error.message}</p>
                `;
            }
        }

        function renderChart(data) {
            const performanceData = data.performance_data;
            const timeline = performanceData.timeline || [];
            
            const series = [];
            
            if (performanceData.performance && performanceData.benchmark) {
                // Create timestamp data
                const startDate = new Date();
                const timelineData = timeline.map((label, index) => {
                    const date = new Date(startDate);
                    date.setMonth(date.getMonth() + index);
                    return date.getTime();
                });

                series.push({
                    name: 'Market Benchmark',
                    data: performanceData.benchmark.map((value, index) => [
                        timelineData[index],
                        value
                    ])
                });
                
                series.push({
                    name: 'Thesis Performance',
                    data: performanceData.performance.map((value, index) => [
                        timelineData[index],
                        value
                    ])
                });
            }

            const chartOptions = {
                series: series,
                chart: {
                    type: 'line',
                    height: 350
                },
                xaxis: {
                    type: 'datetime'
                },
                yaxis: {
                    title: { text: 'Performance Index' }
                },
                title: {
                    text: 'Simulation Performance Chart'
                }
            };

            const chart = new ApexCharts(document.getElementById('chart'), chartOptions);
            chart.render();
        }
    </script>
</body>
</html>